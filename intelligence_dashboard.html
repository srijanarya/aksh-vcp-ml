<!DOCTYPE html>
<html>

<head>
    <title>Announcement Intelligence Dashboard</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            margin-top: 0;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            margin: 0;
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-card p {
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9ff;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-earnings {
            background: #10b981;
            color: white;
        }

        .badge-order {
            background: #f59e0b;
            color: white;
        }

        .badge-capex {
            background: #3b82f6;
            color: white;
        }

        .badge-promoter {
            background: #8b5cf6;
            color: white;
        }

        .badge-general {
            background: #6b7280;
            color: white;
        }

        .status-success {
            color: #10b981;
            font-weight: bold;
        }

        .status-failed {
            color: #ef4444;
        }

        .timestamp {
            color: #6b7280;
            font-size: 0.9em;
        }

        .intelligence-data {
            font-family: 'Courier New', monospace;
            background: #f3f4f6;
            padding: 8px;
            border-radius: 5px;
            font-size: 0.85em;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>üß† Announcement Intelligence Dashboard</h1>
                <p><strong>Last Updated:</strong> <span id="last-update">2025-11-21 12:01:47</span></p>
            </div>
            <button type="button" id="refresh-btn"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-weight: bold; transition: transform 0.2s;">
                üîÑ Refresh Data
            </button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>51</h3>
                <p>Total Announcements</p>
            </div>
            <div class="stat-card">
                <h3>4</h3>
                <p>Successful Extractions</p>
            </div>
            <div class="stat-card">
                <h3>3</h3>
                <p>Categories</p>
            </div>
        </div>

        <h2>üìä Category Breakdown</h2>
        <table>
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Count</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>

                <tr>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>25</td>
                    <td>49.0%</td>
                </tr>

                <tr>
                    <td><span class="badge badge-promoter-action">PROMOTER_ACTION</span></td>
                    <td>22</td>
                    <td>43.1%</td>
                </tr>

                <tr>
                    <td><span class="badge badge-earnings">EARNINGS</span></td>
                    <td>4</td>
                    <td>7.8%</td>
                </tr>

            </tbody>
        </table>

        <h2>üì∞ Recent Announcements</h2>
        <table>
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Company</th>
                    <th>Category</th>
                    <th>Title</th>
                    <th>Extraction</th>
                    <th>Intelligence</th>
                </tr>
            </thead>
            <tbody>

                <tr>
                    <td class="timestamp">2025-11-21T11:53</td>
                    <td>Umiya Mobile Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>Umiya Mobile Ltd - 544464 - Announcement under Reg...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:46</td>
                    <td>Trent Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>Trent Ltd - 500251 - Announcement under Regulation...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:45</td>
                    <td>Kirloskar Electric Company Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>Kirloskar Electric Company Ltd - 533193 - Announce...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:44</td>
                    <td>Winro Commercial India Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>Winro Commercial India Ltd - 512022 - Announcement...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:42</td>
                    <td>Hindalco Industries Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>Hindalco Industries Ltd - 500440 - Intimation Of U...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:42</td>
                    <td>Diligent Media Corporation Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>Diligent Media Corporation Ltd - 540789 - Announce...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:40</td>
                    <td>Dynemic Products Ltd...</td>
                    <td><span class="badge badge-earnings">EARNINGS</span></td>
                    <td>Dynemic Products Ltd - 532707 - General - Updates...</td>
                    <td class="status-success">success</td>
                    <td class="intelligence-data">Financial data extracted</td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:38</td>
                    <td>IDFC First Bank Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>IDFC First Bank Ltd - 539437 - Grant Of Stock Opti...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:38</td>
                    <td>TVS Supply Chain Solutions Ltd...</td>
                    <td><span class="badge badge-earnings">EARNINGS</span></td>
                    <td>TVS Supply Chain Solutions Ltd - 543965 - Announce...</td>
                    <td class="status-success">success</td>
                    <td class="intelligence-data">Financial data extracted</td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:37</td>
                    <td>BJ Duplex Boards Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>BJ Duplex Boards Ltd - 531647 - Post Offer Adverti...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:30</td>
                    <td>Achyut Healthcare Ltd...</td>
                    <td><span class="badge badge-promoter-action">PROMOTER_ACTION</span></td>
                    <td>Achyut Healthcare Ltd - 543499 - Disclosures under...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:30</td>
                    <td>Saraswati Commercial India Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>Saraswati Commercial India Ltd - 512020 - Announce...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:29</td>
                    <td>National Highways Infra Trust...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>National Highways Infra Trust - 543385 - Reg 23(5)...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:29</td>
                    <td>Croissance Ltd...</td>
                    <td><span class="badge badge-promoter-action">PROMOTER_ACTION</span></td>
                    <td>Croissance Ltd - 531909 - Disclosures under Reg. 2...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:27</td>
                    <td>Electrosteel Castings Ltd...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>Electrosteel Castings Ltd - 500128 - Disclosure Un...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:27</td>
                    <td>Jyotirgamya Enterprises Ltd...</td>
                    <td><span class="badge badge-promoter-action">PROMOTER_ACTION</span></td>
                    <td>Jyotirgamya Enterprises Ltd - 539246 - Intimation ...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:26</td>
                    <td>Jindal Steel Ltd...</td>
                    <td><span class="badge badge-promoter-action">PROMOTER_ACTION</span></td>
                    <td>Jindal Steel Ltd - 532286 - Disclosures under Reg....</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:25</td>
                    <td>Porwal Auto Components Ltd...</td>
                    <td><span class="badge badge-promoter-action">PROMOTER_ACTION</span></td>
                    <td>Porwal Auto Components Ltd - 532933 - Disclosures ...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:24</td>
                    <td>Chambal Fertilisers & Chemical...</td>
                    <td><span class="badge badge-promoter-action">PROMOTER_ACTION</span></td>
                    <td>Chambal Fertilisers & Chemicals Ltd - 500085 - Dis...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

                <tr>
                    <td class="timestamp">2025-11-21T11:22</td>
                    <td>India Shelter Finance Corporat...</td>
                    <td><span class="badge badge-general">GENERAL</span></td>
                    <td>India Shelter Finance Corporation Ltd - 544044 - A...</td>
                    <td class="status-failed">skipped</td>
                    <td class="intelligence-data"></td>
                </tr>

            </tbody>
        </table>
    </div>

    <script>
        // Use relative URL to work with port 8001 FastAPI
        const API_URL = '/api/intelligence/announcements';
        const REFRESH_INTERVAL = 30000; // 30 seconds
        let refreshTimer;

        // Refresh button functionality
        document.getElementById('refresh-btn').addEventListener('click', function () {
            this.innerHTML = '‚è≥ Refreshing...';
            this.disabled = true;
            this.style.cursor = 'not-allowed';
            fetchAndUpdateDashboard();
        });

        // Format intelligence data for display
        function formatIntelligence(data) {
            if (!data) return '';

            try {
                if (data.value_cr) {
                    let text = `‚Çπ${parseFloat(data.value_cr).toFixed(2)} Cr`;
                    if (data.client) {
                        text += ` | ${data.client.substring(0, 30)}...`;
                    }
                    return text;
                } else if (data.revenue || data.profit) {
                    return 'Financial data extracted';
                }
            } catch (e) {
                console.error('Error formatting intelligence:', e);
            }

            return 'Data available';
        }

        // Get badge class for category
        function getBadgeClass(category) {
            const categoryLower = category.toLowerCase().replace('_', '-');
            return `badge-${categoryLower}`;
        }



        // Fetch data from API and update dashboard
        async function fetchAndUpdateDashboard() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.status === 'success') {
                    updateDashboard(data);
                    console.log('‚úÖ Dashboard updated successfully');
                } else {
                    console.error('‚ùå API returned error:', data.message);
                }
            } catch (error) {
                console.error('‚ùå Error fetching dashboard data:', error);
                // Don't show error to user, just log it
                // Re-enable refresh button
                const refreshBtn = document.getElementById('refresh-btn');
                refreshBtn.innerHTML = 'üîÑ Refresh Data';
                refreshBtn.disabled = false;
                refreshBtn.style.cursor = 'pointer';
            }
        }
        // Update dashboard with fresh data
        function updateDashboard(response) {
            const data = response.data || {};
            // Update timestamp
            const now = new Date();
            const formattedTime = now.toLocaleString('en-IN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('last-update').textContent = formattedTime;

            // Update stats
            const stats = data.stats || {};
            const totalAnnouncements = stats.total_announcements || 0;
            const successfulExtractions = stats.successful_extractions || 0;
            const categoriesCount = Object.keys(stats.category_counts || {}).length;
            const statsContainer = document.querySelector('.stats');
            statsContainer.innerHTML = `
                <div class="stat-card"><h3>${totalAnnouncements}</h3><p>Total Announcements</p></div>
                <div class="stat-card"><h3>${successfulExtractions}</h3><p>Successful Extractions</p></div>
                <div class="stat-card"><h3>${categoriesCount}</h3><p>Categories</p></div>
            `;

            // Category breakdown table
            let categoryHTML = '';
            const categoryCounts = stats.category_counts || {};
            for (const [cat, count] of Object.entries(categoryCounts)) {
                const pct = totalAnnouncements > 0 ? ((count / totalAnnouncements) * 100).toFixed(1) : 0;
                const badgeClass = getBadgeClass(cat);
                categoryHTML += `<tr><td><span class="badge ${badgeClass}">${cat}</span></td><td>${count}</td><td>${pct}%</td></tr>`;
            }

            // Recent announcements table (limit 10)
            let recentHTML = '';
            const announcements = data.announcements || [];
            const recent = announcements.slice(0, 10);
            for (const ann of recent) {
                const badgeClass = getBadgeClass(ann.category);
                const statusClass = ann.extraction_status === 'success' ? 'status-success' : 'status-failed';
                const intel = formatIntelligence(ann.intelligence_data || {});
                const timestamp = ann.timestamp ? ann.timestamp.replace('T', ' ') : '';
                const company = ann.company_name || '';
                const title = ann.title || '';
                recentHTML += `<tr>
                    <td class="timestamp">${timestamp}</td>
                    <td>${company}</td>
                    <td><span class="badge ${badgeClass}">${ann.category}</span></td>
                    <td>${title}</td>
                    <td class="${statusClass}">${ann.extraction_status || ''}</td>
                    <td class="intelligence-data">${intel}</td>
                </tr>`;
            }

            // Update tables
            const tables = document.querySelectorAll('table');
            if (tables.length >= 2) {
                tables[0].querySelector('tbody').innerHTML = categoryHTML;
                tables[1].querySelector('tbody').innerHTML = recentHTML;
            }

            // Re-enable refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.innerHTML = 'üîÑ Refresh Data';
            refreshBtn.disabled = false;
            refreshBtn.style.cursor = 'pointer';
        }
        // Start auto-refresh
        // Start auto-refresh
        function startAutoRefresh() {
            // Clear any existing timer
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }

            // Fetch immediately on load
            fetchAndUpdateDashboard();

            // Then fetch every 30 seconds
            refreshTimer = setInterval(fetchAndUpdateDashboard, REFRESH_INTERVAL);
            console.log(`üîÑ Auto-refresh enabled (every ${REFRESH_INTERVAL / 1000}s)`);
        }

        // Initialize on page load
        window.addEventListener('load', startAutoRefresh);

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (refreshTimer) {
                clearInterval(refreshTimer);
            }
        });
    </script>
</body>

</html>