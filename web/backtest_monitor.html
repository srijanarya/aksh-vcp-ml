<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtest Monitor - Live Progress</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #666;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .log-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 500px;
            overflow-y: auto;
        }

        .log-container h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .log-entry {
            padding: 10px;
            margin-bottom: 5px;
            border-left: 3px solid #667eea;
            background: #f5f5f5;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-entry.success {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }

        .log-entry.error {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .log-entry.info {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-running {
            background: #4caf50;
            color: white;
        }

        .status-pending {
            background: #ff9800;
            color: white;
        }

        .status-complete {
            background: #2196f3;
            color: white;
        }

        .refresh-info {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.9em;
        }

        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .symbol-item {
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .symbol-item.completed {
            background: #4caf50;
            color: white;
        }

        .symbol-item.running {
            background: #ff9800;
            color: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .eta-display {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš€ Backtest Monitor</h1>
            <p>Small/Mid Cap Strategy - 80 Symbols | 2022-2024</p>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3>Overall Progress</h3>
                <div class="metric" id="progress-pct">0%</div>
                <div class="metric-label">Symbols Analyzed</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-bar" style="width: 0%">0%</div>
                </div>
                <div class="eta-display" id="eta">Calculating...</div>
            </div>

            <div class="card">
                <h3>Current Symbol</h3>
                <div class="metric" id="current-symbol">Loading...</div>
                <div class="metric-label">Processing</div>
                <div class="status-badge status-running" id="status">RUNNING</div>
            </div>

            <div class="card">
                <h3>Trades Generated</h3>
                <div class="metric" id="trades-count">0</div>
                <div class="metric-label">Total Signals</div>
            </div>

            <div class="card">
                <h3>Elapsed Time</h3>
                <div class="metric" id="elapsed-time">00:00:00</div>
                <div class="metric-label">Running</div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 30px;">
            <h3>Symbol Progress (80 Total)</h3>
            <div class="symbol-grid" id="symbol-grid"></div>
        </div>

        <div class="log-container">
            <h3>ðŸ“‹ Recent Activity</h3>
            <div id="log-entries"></div>
        </div>

        <div class="refresh-info">
            âš¡ Auto-refreshing every 5 seconds
        </div>
    </div>

    <script>
        const symbols = [
            "SUZLON", "DIXON", "KPITTECH", "PERSISTENT", "COFORGE", "LTTS", "HAPPSTMNDS", "POLYCAB",
            "KAJARIACER", "DEEPAKNTR", "AARTI", "CLEAN", "FLUOROCHEM", "NAVINFLUOR", "ASTRAL", "MOTHERSON",
            "BALKRISIND", "EXIDEIND", "ESCORTS", "APOLLOTYRE", "SONACOMS", "CUMMINSIND", "THERMAX", "CROMPTON",
            "HAVELLS", "JSWENERGY", "ADANIPOWER", "ADANIGREEN", "SJVN", "NHPC", "PFC", "RECLTD",
            "IRFC", "IRCTC", "CONCOR", "GMRINFRA", "OBEROIRLTY", "GODREJPROP", "PRESTIGE", "DLF",
            "TRENT", "SHOPERSTOP", "RELAXO", "JUBLFOOD", "VBL", "ZYDUSLIFE", "ALKEM", "LALPATHLAB",
            "SYNGENE", "AUROPHARMA", "LUPIN", "TORNTPHARM", "JKCEMENT", "SHREECEM", "RAMCOCEM", "JSWSTEEL",
            "TATASTEEL", "HINDALCO", "SAIL", "NATIONALUM", "VEDL", "NMDC", "BANDHANBNK", "IDFCFIRSTB",
            "RBLBANK", "AUBANK", "MUTHOOTFIN", "M&MFIN", "CHOLAFIN", "SBICARD", "MFSL", "PNBHOUSING",
            "ABCAPITAL", "ICICIGI", "ICICIPRULI", "MAXHEALTH", "NAUKRI", "LATENTVIEW", "ROUTE"
        ];

        let startTime = new Date();
        let completedSymbols = 0;
        let currentSymbol = "SUZLON";
        let totalTrades = 0;

        // Initialize symbol grid
        function initSymbolGrid() {
            const grid = document.getElementById('symbol-grid');
            symbols.forEach(symbol => {
                const div = document.createElement('div');
                div.className = 'symbol-item';
                div.id = `symbol-${symbol}`;
                div.textContent = symbol;
                grid.appendChild(div);
            });
        }

        // Update elapsed time
        function updateElapsedTime() {
            const now = new Date();
            const diff = now - startTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);

            document.getElementById('elapsed-time').textContent =
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Fetch backtest progress
        async function fetchProgress() {
            try {
                const response = await fetch('http://localhost:5001/api/backtest/progress');
                const data = await response.json();

                if (data.status === 'running') {
                    parseLog(data.log);

                    // Update current symbol from API
                    if (data.current_symbol) {
                        currentSymbol = data.current_symbol;
                        document.getElementById('current-symbol').textContent = currentSymbol;
                    }

                    // Update progress from API
                    if (data.completed_count !== undefined) {
                        completedSymbols = data.completed_count;
                        const progress = (completedSymbols / data.total_symbols) * 100;
                        document.getElementById('progress-pct').textContent = `${progress.toFixed(1)}%`;
                        document.getElementById('progress-bar').style.width = `${progress}%`;
                        document.getElementById('progress-bar').textContent = `${completedSymbols}/${data.total_symbols}`;
                    }
                } else if (data.status === 'not_started') {
                    document.getElementById('current-symbol').textContent = 'Not Started';
                    document.getElementById('status').textContent = 'PENDING';
                    document.getElementById('status').className = 'status-badge status-pending';
                } else if (data.status === 'error') {
                    document.getElementById('current-symbol').textContent = 'Error';
                    addLogEntry(`âŒ Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Failed to fetch progress:', error);
                addLogEntry('âš ï¸ Connection error - retrying...', 'error');
            }
        }

        // Parse log file
        function parseLog(logText) {
            const lines = logText.split('\n');
            const analyzingLines = lines.filter(line => line.includes('ðŸ” Analyzing'));

            if (analyzingLines.length > 0) {
                const lastLine = analyzingLines[analyzingLines.length - 1];
                const match = lastLine.match(/Analyzing (\w+)\.NS/);
                if (match) {
                    currentSymbol = match[1];
                    document.getElementById('current-symbol').textContent = currentSymbol;

                    // Mark as running
                    document.querySelectorAll('.symbol-item.running').forEach(el => {
                        el.classList.remove('running');
                        el.classList.add('completed');
                    });

                    const currentEl = document.getElementById(`symbol-${currentSymbol}`);
                    if (currentEl) {
                        currentEl.classList.add('running');
                    }
                }
            }

            // Count completed backtests
            const completedCount = (logText.match(/Backtest complete/g) || []).length;
            completedSymbols = Math.floor(completedCount / 5); // 5 walk-forward windows per symbol

            // Update progress
            const progress = Math.min(100, (completedSymbols / symbols.length) * 100);
            document.getElementById('progress-pct').textContent = `${progress.toFixed(1)}%`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-bar').textContent = `${completedSymbols}/${symbols.length}`;

            // Calculate ETA
            if (completedSymbols > 0) {
                const elapsed = (new Date() - startTime) / 1000; // seconds
                const avgTimePerSymbol = elapsed / completedSymbols;
                const remaining = symbols.length - completedSymbols;
                const etaSeconds = remaining * avgTimePerSymbol;

                const etaHours = Math.floor(etaSeconds / 3600);
                const etaMinutes = Math.floor((etaSeconds % 3600) / 60);
                document.getElementById('eta').textContent =
                    `ETA: ${etaHours}h ${etaMinutes}m remaining`;
            }

            // Count trades
            const tradeMatches = logText.match(/Trades: (\d+)/g) || [];
            totalTrades = tradeMatches.reduce((sum, match) => {
                const num = parseInt(match.match(/\d+/)[0]);
                return sum + num;
            }, 0);
            document.getElementById('trades-count').textContent = totalTrades;

            // Add recent log entries
            addLogEntries(lines.slice(-20));
        }

        // Add log entries
        function addLogEntries(lines) {
            const logContainer = document.getElementById('log-entries');
            logContainer.innerHTML = '';

            lines.filter(line => line.trim().length > 0).forEach(line => {
                const div = document.createElement('div');
                div.className = 'log-entry';

                if (line.includes('âœ…') || line.includes('complete')) {
                    div.classList.add('success');
                } else if (line.includes('âŒ') || line.includes('Error')) {
                    div.classList.add('error');
                } else if (line.includes('ðŸ”') || line.includes('Beta')) {
                    div.classList.add('info');
                }

                div.textContent = line.substring(0, 150);
                logContainer.appendChild(div);
            });
        }

        // Add single log entry
        function addLogEntry(message, type = 'info') {
            const logContainer = document.getElementById('log-entries');
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.textContent = message;
            logContainer.insertBefore(div, logContainer.firstChild);

            // Keep only last 20 entries
            while (logContainer.children.length > 20) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // Initialize
        initSymbolGrid();
        updateElapsedTime();
        setInterval(updateElapsedTime, 1000);
        setInterval(fetchProgress, 5000);

        // Initial fetch
        fetchProgress();
    </script>
</body>
</html>
